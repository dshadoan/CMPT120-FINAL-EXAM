# CMPT120 FINAL PROJECT ATM PROGRAM

def loadUserData():
    userData = {}
    lineNum = 0
    with open("userData.txt", "r") as file:
        for line in file:
            cardNumber, cardPin, cardBalance = line.strip().split(",")
            userData[cardNumber] = (cardPin, float(cardBalance), lineNum)
            lineNum = lineNum + 1
    return userData

def verifyUser(userData, cardNumber, pin):
    if cardNumber in userData:
        stored_password = userData[cardNumber][0]
        if stored_password == pin:
            return True
    return False

def withdraw(userData, cardNumber):
    amount = float(input("Type in the amount you like to withdraw: "))
    if amount <= userData[cardNumber][1]:
        userData[cardNumber] = (userData[cardNumber][0], userData[cardNumber][1] - amount, userData[cardNumber][2])
        print(f"Withdrawal complete. Remaining balance: {userData[cardNumber][1]}")
        oldFile = open("userData.txt", "r")
        oldFile = oldFile.readlines()
        oldFile[userData[cardNumber][2]] = str(cardNumber) + "," + str(userData[cardNumber][0]) + "," + str(userData[cardNumber][1]) + "\n"
        newStr = ""
        for line in oldFile:
            newStr = newStr + line
        writeWithdraw = open("userData.txt", "w")
        writeWithdraw.write(newStr)

    else:
        print("Failed withdrawal, insufficient funds.")

def deposit(userData, cardNumber):
    amount = float(input("Type in the amount you would like to deposit: "))
    userData[cardNumber] = (userData[cardNumber][0], userData[cardNumber][1] + amount, userData[cardNumber][2])
    print(f"Deposit complete. Current Balance: {userData[cardNumber][1]}")
    oldFile = open("userData.txt", "r")
    oldFile = oldFile.readlines()
    oldFile[userData[cardNumber][2]] = str(cardNumber) + "," + str(userData[cardNumber][0]) + "," + str(
        userData[cardNumber][1]) + "\n"
    newStr = ""
    for line in oldFile:
        newStr = newStr + line
    writeWithdraw = open("userData.txt", "w")
    writeWithdraw.write(newStr)

def transferFunction(userData, donorCardNumber):
    recipientsCardNum = input("Enter the recipient's card number: ")
    if recipientsCardNum not in userData:
        print("Recipient's account invalid.")
    else:
        transferAmount = float(input("Enter transfer amount: "))
        if transferAmount > userData[donorCardNumber][1]:
            print("Transfer rejected due to insufficient funds.")
        else:
            userData[donorCardNumber] = (userData[donorCardNumber][0], userData[donorCardNumber][1] - transferAmount, userData[donorCardNumber][2])
            userData[recipientsCardNum] = (userData[recipientsCardNum][0], userData[recipientsCardNum][1] + transferAmount, userData[recipientsCardNum][2])
            print(f"Transfer was successful.You now have {userData[donorCardNumber][1]}" )
            oldFile = open("userData.txt", "r")
            oldFile = oldFile.readlines()
            oldFile[userData[donorCardNumber][2]] = str(donorCardNumber) + "," + str(userData[donorCardNumber][0]) + "," + str(userData[donorCardNumber][1]) + "\n"
            oldFile[userData[recipientsCardNum][2]] = str(recipientsCardNum) + "," + str(userData[recipientsCardNum][0]) + "," + str(userData[recipientsCardNum][1]) + "\n"

            newStr = ""
            for line in oldFile:
                newStr = newStr + line
            writeWithdraw = open("userData.txt", "w")
            writeWithdraw.write(newStr)


def main():
    userData = loadUserData()

    while True:
        print("Hello. Welcome to the ATM.")
        cardNumber = input("Please input your account number attached to your debit card: ")
        cardPin = input("Please enter your 4-digit pin number attached to your account: ")

        if verifyUser(userData, cardNumber, cardPin):
            print("Information Verified. Access Granted.")

            while True:
                print("What action would you like to perform?\n1. Withdraw\n2. Deposit\n3. Transfer\n4. Log Out")
                action = input("Enter the number for your choice (1, 2, 3, or 4): ")

                if action == "1":
                    withdraw(userData, cardNumber)
                elif action == "2":
                    deposit(userData, cardNumber)
                elif action == "3":
                    transferFunction(userData, cardNumber)
                elif action == "4":
                    print("Have a good day.")
                    # storeUserData(userData)  # It seems you haven't defined this function.
                    exit()
                else:
                    print("Please type in a valid choice of 1, 2, 3, or 4.")
        else:
            print("Verification failed.")

if __name__ == "__main__":
    main()
